<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MARGDARSHAN Login (Firebase)</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 2rem; max-width: 400px; margin: auto; }
  input, button { width: 100%; padding: 10px; margin-top: 1rem; font-size: 1rem; }
  button { cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
  button:hover { background-color: #0056b3; }
  .error { color: red; margin-top: 1rem; }
</style>
</head>
<body>
<h2>MARGDARSHAN Portal Login</h2>

<input id="email" type="email" placeholder="Email" required />
<input id="password" type="password" placeholder="Password" required />
<button id="loginBtn">Login / Register</button>
<div class="error" id="errorMsg"></div>

<script>
  // Your Firebase config here (replace with your own)
  const firebaseConfig = {
    apiKey: "AIzaSyCtk623Jq7dPCK9hKokiAkwdOeFseCtOe0",
    authDomain: "margdarshan-portal.firebaseapp.com",
    projectId: "margdarshan-portal",
    storageBucket: "margdarshan-portal.firebasestorage.app",
    messagingSenderId: "643677914032",
    appId: "1:643677914032:web:dd242795a661ffff040c75"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const loginBtn = document.getElementById('loginBtn');
  const errorMsg = document.getElementById('errorMsg');

  loginBtn.onclick = () => {
    errorMsg.textContent = '';
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!email || !password) {
      errorMsg.textContent = "Please enter email and password.";
      return;
    }

    // Try login, if user does not exist, create new user (register)
    auth.signInWithEmailAndPassword(email, password)
      .then(userCredential => {
        // User logged in
        const user = userCredential.user;
        // Check if user doc exists in Firestore
        db.collection('users').doc(user.uid).get().then(docSnap => {
          if (!docSnap.exists) {
            // New user doc - create with default role = student
            db.collection('users').doc(user.uid).set({
              email: user.email,
              role: 'student',
              name: user.email.split('@')[0],
              createdAt: new Date()
            }).then(() => {
              // Redirect based on role
              window.location.href = 'student.html';
            });
          } else {
            // Redirect based on stored role
            const data = docSnap.data();
            redirectByRole(data.role);
          }
        });
      })
      .catch(error => {
        if (error.code === 'auth/user-not-found') {
          // User does not exist, register them
          auth.createUserWithEmailAndPassword(email, password)
            .then(userCredential => {
              const user = userCredential.user;
              // Create user doc
              db.collection('users').doc(user.uid).set({
                email: user.email,
                role: 'student',
                name: user.email.split('@')[0],
                createdAt: new Date()
              }).then(() => {
                window.location.href = 'student.html';
              });
            })
            .catch(err => {
              errorMsg.textContent = err.message;
            });
        } else {
          errorMsg.textContent = error.message;
        }
      });
  };

  function redirectByRole(role) {
    if(role === 'admin') window.location.href = 'admin.html';
    else if(role === 'mentor') window.location.href = 'mentor.html';
    else window.location.href = 'student.html';
  }
</script>

</body>
</html>
